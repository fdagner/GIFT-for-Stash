<html>
<head>
<!-- https://github.com/eligrey/FileSaver.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h1>Generator für MC-Fragen</h1>
  <p>Dieses Script generiert MC-Fragen für Moodle im GIFT-Format</p>
  <script>

    function randnum(length) {
      return Math.floor(Math.random() * length);
    }

    // Array für die Codes
    var codes = [];

    // Hier die anzuzeigende Mitteilung einfügen
    var message = "Wähle mich!";

    // Anzahl der zu generierenden Fragen
    var anzahl;

    // Anzahl der Antwortoptionen pro Frage
    var optionen;

    // Funktion zum Hinzufügen eines neuen Inputfelds
    function addInput() {
      var inputContainer = document.getElementById("input-container");
      var newInput = document.createElement("input");
      newInput.type = "text";
      newInput.name = "code[]";
      inputContainer.appendChild(newInput);
    }

    // Funktion zum Generieren der Fragen
    function generateQuestions() {
      // Array mit den eingegebenen Codes erstellen
      var codeInputs = document.getElementsByName("code[]");
      for (var i = 0; i < codeInputs.length; i++) {
        codes.push(codeInputs[i].value);
      }
      // Anzahl der Antwortoptionen aktualisieren
      optionen = document.getElementById("optionen-auswahl").value;
      // Anzahl der Fragen aktualisieren
      anzahl = document.getElementById("anzahl-auswahl").value;
      // Fragen generieren
      var fragenContainer = document.getElementById("fragen-container");
      fragenContainer.innerHTML = ""; // Löschen des Inhalts des Containers
      for (var i = 1; i <= anzahl; i++) {
        var frage = document.createElement("p");
        frage.innerHTML = "::Frage" + i + "::<br>Wähle eine Option aus.{<br>";
        for (var j = 0; j < optionen; j++) {
          var addstr = "";
          if (j > 0) addstr = "~";
          var antwort = document.createElement("span");
          antwort.innerHTML = addstr + "=Wähle mich!#[stashdrop secret\\=\"" + codes[randnum(codes.length)] + "\" text\\=\"" + message + "\" image]<br>";
          frage.appendChild(antwort);
        }
        var endbr = document.createElement("span");
        endbr.innerHTML = "}<br>";
        frage.appendChild(endbr);
        fragenContainer.appendChild(frage);
      }
     var myFile = new File([fragenContainer.innerText], "GIFTforStash.txt", {type: "text/plain;charset=utf-8"});
     saveAs(myFile);
    }

  </script>
    <!-- Dateiupload -->
  <p>Codes per Datei hochladen: <input type="file" id="file-input" onchange="handleFileUpload()"></p>
  <details><summary>Dateiformat</summary>
  <ul>
    <li>Lade eine Datei mit einer Liste der secret-Codes hoch (eine Zeile ein Code)</li>
    <li>Oder lade eine Datei mit einer Liste der Shortcodes hoch (eine Zeile ein Shortcode)</li>
  </ul>
  </details><br>
  <!-- Inputfelder für die Codes -->
   <div style="display: flex">
  <div id="input-container">
    <input type="text" name="code[]" value=""><input type="text" name="code[]" value=""></div>
  </div><br>
  <button onclick="addInput()">Weiteren Code hinzufügen</button>
 
  <!-- Auswahlfeld für die Anzahl der Antwortoptionen -->
  <p>Anzahl der Antwortoptionen:</p>
  <input id="optionen-auswahl" type="number" min="1" max="10" value="4">
 <!-- Auswahlfeld für die Anzahl der Fragen -->
  <p>Anzahl der zu generierenden Fragen:</p>
  <input id="anzahl-auswahl" type="number" min="1" max="30" value="10">
  <!-- Button zum Generieren der Fragen -->
  <button onclick="generateQuestions()">Fragen generieren</button>
  <!-- Container für die generierten Fragen -->
  <div id="fragen-container"></div>

  <script>
    function addInput() {
      var inputContainer = document.getElementById("input-container");
      var newInput = document.createElement("input");
      newInput.type = "text";
      newInput.name = "code[]";
      newInput.value = "";
      inputContainer.appendChild(newInput);
    }
    function handleFileUpload() {
      var fileInput = document.getElementById("file-input");
      var file = fileInput.files[0];
      var reader = new FileReader();
      reader.readAsText(file);
      reader.onload = function (event) {
        var inputContainer = document.getElementById("input-container");
        var codes = [];
        var text = event.target.result;
        if (text.indexOf("[stashdrop") !== -1) {
          // Shortcode format
          var matches = text.match(/secret="([^"]+)"/g);
          if (matches) {
            for (var i = 0; i < matches.length; i++) {
              var code = matches[i].match(/secret="([^"]+)"/)[1];
              codes.push(code);
              if (i >= 2) {
                // Nur neue Input-Felder füllen
                var newInput = document.createElement("input");
                newInput.type = "text";
                newInput.name = "code[]";
                newInput.value = code;
                inputContainer.appendChild(newInput);
              }
            }
            // Die ersten beiden Werte in die zwei existrierenden Inputs füllen
            var existingInputs = document.querySelectorAll("#input-container input.existing-input");
            for (var i = 0; i < 2 && i < existingInputs.length && i < codes.length; i++) {
              existingInputs[i].value = codes[i];
            }
            // Die ersten beiden Werte entfernen
            codes.splice(0, 2);
          } 
        } else {
          // CSV format
          codes = text.split("\n");
          for (var i = 0; i < codes.length; i++) {
            if (i >= 2) {
              // Nur neue Input-Felder füllen
              var newInput = document.createElement("input");
              newInput.type = "text";
              newInput.name = "code[]";
              newInput.value = codes[i];
              inputContainer.appendChild(newInput);
            }
          }
          // Die ersten beiden Werte in die zwei existrierenden Inputs füllen
          var existingInputs = document.querySelectorAll("#input-container input.existing-input");
          for (var i = 0; i < 2 && i < existingInputs.length && i < codes.length; i++) {
            existingInputs[i].value = codes[i];
          }
          // Die ersten beiden Werte entfernen
          codes.splice(0, 2);
        }

      }
    }

    // Existierende Inputs markieren
    var existingInputs = document.getElementsByName("code[]");
    for (var i = 0; i < existingInputs.length; i++) {
      existingInputs[i].classList.add("existing-input");
    }
  </script>
</body>
</html>
